name: CI/CD

on:
  push:
    branches: ["main", "master", "backend", "frontend"]
  pull_request:
    branches: ["main", "master", "backend", "frontend"]

env:
  # PostgreSQL Settings
  POSTGRES_USER: wdeaf_admin
  POSTGRES_PASSWORD: test_password_ci
  DB_NAME: wdeaf_db
  DB_USER: wdeaf_user
  DB_PASSWORD: test_password_ci
  
  # Django Settings
  DEBUG: "True"
  SECRET_KEY: ci-secret-key-for-testing
  ALLOWED_HOSTS: localhost,127.0.0.1
  DB_ENGINE: django.db.backends.postgresql
  DB_HOST: localhost
  DB_PORT: "5432"
  
  # JWT Settings
  JWT_SECRET: ci-jwt-secret-key-for-testing
  JWT_ALGORITHM: HS256
  JWT_EXPIRATION_HOURS: "24"
  
  # CORS & CSRF
  ALLOWED_ORIGINS: http://localhost:5173,http://localhost:3000
  CSRF_TRUSTED_ORIGINS: http://localhost:5173,http://localhost:3000,http://localhost:8000
  CSRF_COOKIE_HTTPONLY: "False"
  CSRF_COOKIE_SAMESITE: Lax
  CSRF_COOKIE_SECURE: "False"
  
  # Redis Settings
  REDIS_HOST: localhost
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_PASSWORD: ""
  
  # Telegram
  BOT_TOKEN: ci-bot-token
  TELEGRAM_BOT_TOKEN: ci-bot-token

jobs:
  # ============================================================================
  # Backend Tests
  # ============================================================================
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.DB_NAME }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd "pg_isready -U ${{ env.POSTGRES_USER }}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'
          cache-dependency-path: backend_project/requirements.txt

      - name: Install backend dependencies
        working-directory: ./backend_project
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U ${{ env.POSTGRES_USER }}; then
              echo "PostgreSQL is ready"
              exit 0
            fi
            sleep 1
          done
          echo "PostgreSQL is not ready after 30 seconds"
          exit 1

      - name: Create database user and grant permissions
        run: |
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "CREATE USER ${{ env.DB_USER }} WITH PASSWORD '${{ env.DB_PASSWORD }}';" || true
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "GRANT ALL PRIVILEGES ON DATABASE ${{ env.DB_NAME }} TO ${{ env.DB_USER }};"
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "GRANT ALL ON SCHEMA public TO ${{ env.DB_USER }};"

      - name: Run backend migrations
        working-directory: ./backend_project
        env:
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
        run: python manage.py migrate

      - name: Run backend tests
        working-directory: ./backend_project
        env:
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
        run: python manage.py test api.tests --verbosity=2

      - name: Check Django collectstatic
        working-directory: ./backend_project
        run: python manage.py collectstatic --noinput --dry-run

  # ============================================================================
  # Backend Security & Code Quality
  # ============================================================================
  backend-security:
    name: Backend Security & Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install security tools
        run: |
          pip install bandit safety pip-audit flake8

      - name: Run bandit (security linter)
        working-directory: ./backend_project
        continue-on-error: true
        run: bandit -r . -ll -ii

      - name: Check for known vulnerabilities in dependencies
        working-directory: ./backend_project
        continue-on-error: true
        run: |
          pip install -r requirements.txt
          safety check --full-report || echo "Safety check completed"
          pip-audit || echo "Pip-audit completed"

      - name: Run flake8
        working-directory: ./backend_project
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # ============================================================================
  # Frontend Type Check & Lint
  # ============================================================================
  frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run TypeScript type check (no implicit any)
        working-directory: ./frontend
        run: npm run type-check

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Run ESLint (check for any types)
        working-directory: ./frontend
        run: |
          # Дополнительная проверка на наличие any в коде
          if grep -rn ": any" src/ --include="*.ts" --include="*.tsx" --include="*.vue" | grep -v "node_modules"; then
            echo "Error: Found explicit 'any' types in codebase"
            exit 1
          fi
          echo "No explicit 'any' types found"

  # ============================================================================
  # Frontend Build
  # ============================================================================
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [frontend-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:8000
          VITE_BOT_USERNAME: wdeaf_bot
          VITE_DEBUG: "false"
        run: npm run build

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

  # ============================================================================
  # Docker Build Test
  # ============================================================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend_project
          file: ./backend_project/Dockerfile
          push: false
          load: true
          tags: wdeaf-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          load: true
          tags: wdeaf-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test backend container start
        run: |
          docker run -d --name test-backend \
            -e DEBUG=True \
            -e SECRET_KEY=test-key \
            -e ALLOWED_HOSTS=localhost \
            -e DB_ENGINE=django.db.backends.postgresql \
            -e DB_NAME=${{ env.DB_NAME }} \
            -e DB_USER=${{ env.DB_USER }} \
            -e DB_PASSWORD=${{ env.DB_PASSWORD }} \
            -e DB_HOST=localhost \
            -e DB_PORT=5432 \
            -e JWT_SECRET=test-jwt \
            -e JWT_ALGORITHM=HS256 \
            -e JWT_EXPIRATION_HOURS=24 \
            -e ALLOWED_ORIGINS=http://localhost:5173 \
            -e CSRF_TRUSTED_ORIGINS=http://localhost:5173 \
            -e CSRF_COOKIE_HTTPONLY=False \
            -e CSRF_COOKIE_SAMESITE=Lax \
            -e CSRF_COOKIE_SECURE=False \
            -e REDIS_HOST=localhost \
            -e REDIS_PORT=6379 \
            -e REDIS_DB=0 \
            wdeaf-backend:test \
            python manage.py check

      - name: Cleanup test container
        if: always()
        run: docker rm -f test-backend || true

  # ============================================================================
  # Docker Compose Integration Test
  # ============================================================================
  docker-compose-test:
    name: Docker Compose Integration
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build, docker-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          DB_NAME=${{ env.DB_NAME }}
          DB_USER=${{ env.DB_USER }}
          DB_PASSWORD=${{ env.DB_PASSWORD }}
          DB_ENGINE=${{ env.DB_ENGINE }}
          DB_HOST=wdeaf-postgres
          DB_PORT=5432
          DEBUG=True
          SECRET_KEY=${{ env.SECRET_KEY }}
          ALLOWED_HOSTS=localhost,127.0.0.1
          JWT_SECRET=${{ env.JWT_SECRET }}
          JWT_ALGORITHM=${{ env.JWT_ALGORITHM }}
          JWT_EXPIRATION_HOURS=${{ env.JWT_EXPIRATION_HOURS }}
          ALLOWED_ORIGINS=http://localhost:5173
          CSRF_TRUSTED_ORIGINS=http://localhost:5173
          CSRF_COOKIE_HTTPONLY=False
          CSRF_COOKIE_SAMESITE=Lax
          CSRF_COOKIE_SECURE=False
          REDIS_HOST=wdeaf-redis
          REDIS_PORT=6379
          REDIS_DB=0
          BOT_TOKEN=${{ env.BOT_TOKEN }}
          FRONTEND_PORT=5173
          BACKEND_PORT=8000
          POSTGRES_PORT=5432
          EOF

      - name: Start services with database initialization
        run: |
          docker compose up -d postgres redis
          sleep 10
          
          # Initialize database user and permissions
          docker compose exec -T postgres psql -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "CREATE USER ${{ env.DB_USER }} WITH PASSWORD '${{ env.DB_PASSWORD }}';" || true
          docker compose exec -T postgres psql -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "GRANT ALL PRIVILEGES ON DATABASE ${{ env.DB_NAME }} TO ${{ env.DB_USER }};"
          docker compose exec -T postgres psql -U ${{ env.POSTGRES_USER }} -d ${{ env.DB_NAME }} -c "GRANT ALL ON SCHEMA public TO ${{ env.DB_USER }};"
          
          # Start remaining services
          docker compose up -d backend frontend
          sleep 15

      - name: Check all services are healthy
        run: |
          docker compose ps
          docker compose ps | grep -q "wdeaf-postgres.*healthy" || exit 1
          docker compose ps | grep -q "wdeaf-redis.*healthy" || exit 1
          docker compose ps | grep -q "wdeaf-django-backend.*Up" || exit 1
          docker compose ps | grep -q "wdeaf-frontend.*Up" || exit 1

      - name: Test backend health endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1

      - name: Show backend logs on failure
        if: failure()
        run: docker compose logs backend

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8 on backend
        working-directory: ./backend_project
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Python linting found issues"

      - name: Check .env.example completeness
        run: |
          if [ -f .env.example ]; then
            echo "Checking .env.example completeness..."
            grep -q "POSTGRES_USER" .env.example || echo "Warning: POSTGRES_USER not in .env.example"
            grep -q "POSTGRES_PASSWORD" .env.example || echo "Warning: POSTGRES_PASSWORD not in .env.example"
            grep -q "DB_USER" .env.example || echo "Warning: DB_USER not in .env.example"
            grep -q "DB_PASSWORD" .env.example || echo "Warning: DB_PASSWORD not in .env.example"
            echo ".env.example check completed"
          fi
